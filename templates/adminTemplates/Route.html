{% extends 'adminTemplates/base.html' %}
{% load static %}

{% block content %}
{% if messages %}

{% for message in messages %}
{% if message.tags == 'success' %}

<script>
    console.log('{{message}}')
    Swal.fire({
        position: "center",
        icon: "success",
        title: "{{message}}",
        showConfirmButton: false,
        timer: 1500
    });
</script>
{% endif %}
{% if message.tags == 'error' %}
<script>

    Swal.fire({
        position: "center",
        icon: "error",
        title: "{{message}}",
        showConfirmButton: false,
        timer: 2000
    });
</script>
{% endif %}
{% endfor %}
{% endif %}
<div>
    <div>
        <div>
            <button class="btn btn-light mb-5 ms-5" data-collapse="#collapsible_content">
                Create New Routes
            </button>
            <div class="card transition-all duration-300 hidden" id="collapsible_content">
                <div class="card-header">
                    <h3 class="card-title">New Car</h3>
                </div>
                <div class="card-body">
                    <form action="{% url 'add-route' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                    Trip Type<span class="text-danger">*</span>
                                </label>
                                <select class="select w-full border border-gray-300 p-2 rounded-md transition duration-300 ease-in-out hover:bg-[#00b0c3] hover:text-white" name="tripType">
                                    <option value="oneway" >Oneway</option>
                                    <option value="roundtrip">Roundtrip</option>
                                    <option value="local">Local</option>
                                    <option value="airport_pickup">Airport Pickup</option>
                                    <option value="airport_drop">Airport Drop</option>
                                </select>
                                
                            </div>
                            <!-- Pickup Input -->
                            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                    Pickup
                                    <span class="text-danger">*</span>
                                </label>
                                <input class="select-input input w-full pickup" name="pickup" onkeyup="processChange()" autocomplete="off"
                                    placeholder="pickup" type="text" required />
                                <div class="select-dropdown autocomplete-results dropdown-menu"></div>
                            </div>
                            <!-- Drop Off Input -->
                            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                    Drop Off
                                    <span class="text-danger">*</span>
                                </label>
                                <input class="select-input input w-full pickup" onkeyup="processChange()" name="DropOff" autocomplete="off"
                                    placeholder="Drop Off" type="text" />
                                <div class="select-dropdown autocomplete-results dropdown-menu"></div>
                            </div>
                            <!-- Duration Input -->
                            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                    Duration<span class="text-2sm text-gray-600">(Only for Local)</span>
                                </label>
                                <select class="select w-full" name="duration">
                                    <option value="none">none</option>
                                    <option value="4 hrs 40 km">4 hrs 40 km</option>
                                    <option value="8 hrs 80 km">8 hrs 80 km</option>
                                    <option value="12 hrs 120 km">12 hrs 120 km</option>
                                </select>
                            </div>
                            <!-- KMS Input -->
                            <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                    KMS<span class="text-2sm text-gray-600">(Not for Local)</span>
                                    <span class="text-danger">*</span>
                                </label>
                                <input class="input w-full" name="Kilometers" placeholder="Kilometers" type="number" />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4">
                                <!-- Car Type and Fare Input Rows Container -->
                                <div class="col-span-2 lg:col-span-4 p-4" id="car-fare-container"
                                    style="border: 1px solid;box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);background-color: #fff;border-radius: 0.5rem;">
                                    <!-- Initial Row for Car Type and Fare -->
                                    <div class="flex flex-wrap lg:flex-nowrap lg:items-center gap-4 car-fare-row">
                                        <!-- Car Type -->
                                        <div class="flex items-baseline gap-2.5 w-full lg:w-auto">
                                            <label class="form-label">Car Model:</label>
                                            <div class="autocomplete" style="width:300px;">
                                                <input class="input w-full autoInput" id="carModal" type="text"
                                                    name="carModelId[]" placeholder="Car Model" autocomplete="off">
                                            </div>
                                        </div>
                                        <!-- Fare -->
                                        <div class="flex items-baseline gap-2.5 w-full lg:w-auto">
                                            <label class="form-label">Fare:</label>
                                            <input class="input w-full" name="fare[]" placeholder="Fare" type="number"
                                                step="0.01" required />
                                        </div>
                                        <!-- Delete Button -->
                                        <button type="button" class="btn btn-danger btn-sm delete-row">
                                            <i class="ki-filled ki-cross-circle"></i>
                                        </button>
                                    </div>
                                    <!-- More Button (Initially Visible) -->
                                    <div id="more-button-container" class="flex justify-end mt-2">
                                        <button type="button" id="add-more-btn" class="btn btn-sm btn-secondary">
                                            <i class="ki-filled ki-plus-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Submit Button -->
                            <div class="flex justify-end mt-4">
                                <button class="btn btn-sm btn-primary" type="submit" style="background-color: #00b0c3; color: white;">
                                    Add Route
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- end: container -->
    <div class="container-fixed">
        <div class="grid gap-5 lg:gap-7.5">
            <div class="card card-grid min-w-full">
                <div class="card-header py-5 flex-wrap">
                    <h3 class="card-title">
                        Vahan Routes
                        <div style="display: inline-block;" class="ml-5">
                            <button class="btn btn-danger btn-sm" type="button" onclick="DeleteRoutes()">
                                <i class="ki-filled ki-trash"></i>
                                Delete
                            </button>
                        </div>
                    </h3>
                    <div class="flex gap-6">
                        <div class="relative">
                            <i
                                class="ki-outline ki-magnifier leading-none text-md text-gray-500 absolute top-1/2 left-0 -translate-y-1/2 ml-3">
                            </i>
                            <input class="input input-sm pl-8" onkeyup="filterTable()" placeholder="Search Users"
                                id="searcRotute" type="text" />

                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div data-datatable="true" data-datatable-page-size="5">
                        <div class="scrollable-x-auto">
                            <table class="table table-auto table-border" data-datatable-table="true" id="route_table">
                                <thead>
                                    <tr>
                                        <th class="w-[60px]">
                                            <input class="checkbox checkbox-sm" data-datatable-check="true"
                                                type="checkbox" />
                                        </th>
                                        <th class="w-[80px]">
                                        </th>
                                        <th class="min-w-[175px]">
                                            <span class="sort asc">
                                                <span class="sort-label">
                                                    Trip type
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[150px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Pickup location
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Drop location
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Car Model
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Fare
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Duration
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Kms
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>
                                        <th class="min-w-[125px]">
                                            <span class="sort">
                                                <span class="sort-label">
                                                    Created by
                                                </span>
                                                <span class="sort-icon">
                                                </span>
                                            </span>
                                        </th>

                                    </tr>
                                </thead>
                                <tbody>
                                    {% for routeData in routeData %}
                                    <tr>
                                        <td>
                                            <input class="checkbox checkbox-sm" data-datatable-row-check="true"
                                                type="checkbox" id="checkBOX" value="{{routeData.id}}" />
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-light"
                                                data-modal-toggle="#CarsUpdateModal-{{routeData.id}}">
                                                <i class="ki-filled ki-pencil"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <div class="flex items-center gap-2.5">

                                                <div class="flex flex-col gap-0.5">
                                                    <a
                                                        class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">
                                                        {{ routeData.trip_type }}
                                                    </a>
                                                    <span class="text-2sm text-gray-600">
                                                        <hr style="height: 1rem;">
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="flex items-center gap-1.5">{{ routeData.pickup_location }}</div>
                                        </td>
                                        <td>{{ routeData.drop_location }}</td>
                                        <td>
                                            {{ routeData.car_type.car_model}}


                                        </td>
                                        <td>{{ routeData.fare }}</td>
                                        <td>{{routeData.duration}}</td>
                                        <td>{{routeData.kms}}</td>
                                        <td title="{{routeData.created_by}}">{{routeData.created_by.name}}(<span
                                                class="text-2sm text-gray-600">{{routeData.created_by}}</span>)</td>
                                    </tr>
                                    <div class="modal" data-modal="true" id="CarsUpdateModal-{{routeData.id}}">
                                        <form id="carEditForm" method="post" enctype="multipart/form-data"
                                            action="{% url 'edit-routes' %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="routeId" value="{{ routeData.id }}">
                                            <div class="modal-content max-w-[600px] top-[10%]">
                                                <div class="modal-header">
                                                    <h3 class="modal-title">Edit </h3>
                                                    <button type="button" class="btn btn-xs btn-icon btn-light"
                                                        data-modal-dismiss="true">
                                                        <i class="ki-outline ki-cross"></i>
                                                    </button>
                                                </div>

                                                <div class="modal-body">
                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Trip Type<span class="text-danger">*</span>
                                                        </label>
                                                        <select class="select w-full" name="tripTypeEdit" required>
                                                            <option value="oneway" {% if routeData.trip_type == 'oneway' %}selected{% endif %}>Oneway</option>
                                                            <option value="roundtrip" {% if routeData.trip_type == 'roundtrip' %}selected{% endif %}>
                                                                Roundtrip</option>
                                                            <option value="local" {% if routeData.trip_type == 'local' %}selected{% endif %}>Local</option>
                                                            <option value="airport_pickup" {% if routeData.trip_type == 'airport_pickup' %}selected{% endif %}>Airport Pickup</option>
                                                            <option value="airport_drop" {% if routeData.trip_type == 'airport_drop' %}selected{% endif %}>Airport Drop</option>
                                                        </select>
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Pickup
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <input class="select-input input w-full pickup"
                                                            name="pickupEdit" onkeyup="processChange()"
                                                            value="{{ routeData.pickup_location }}" placeholder="pickup"
                                                            type="text" required />
                                                        <div class="select-dropdown autocomplete-results dropdown-menu">
                                                        </div>
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Drop Off
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <input class="select-input input w-full pickup"
                                                            onkeyup="processChange()" name="dropOffEdit"
                                                            placeholder="Drop Off" type="text"
                                                            value="{{ routeData.drop_location }}" />
                                                        <div class="select-dropdown autocomplete-results dropdown-menu">
                                                        </div>
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Car Type
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        
                                                            <div class="autocomplete" style="width:300px;">
                                                                <input class="input w-full autoInput" id="carModalRoute" type="text" name="carModelRuteId"
                                                                  value="{{ routeData.car_type.car_model }}"  placeholder="Car Model" autocomplete="off">
                                                            </div>
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Fare
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <input class="input w-full" name="fareEdit" placeholder="Fare"
                                                            type="number" value="{{ routeData.fare }}" required />
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            KMS
                                                            <span class="text-2sm text-gray-600">(Not for Local)</span>
                                                        </label>
                                                        <input class="input w-full" name="kmsEdit"
                                                            placeholder="Kilometers" type="number"
                                                            value="{{ routeData.kms }}" />
                                                    </div>

                                                    <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                        <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                            Duration<span class="text-2sm text-gray-600">(Only for
                                                                Local)</span>
                                                        </label>
                                                        <select class="select w-full" name="duration">
                                                            <option value="none" {% if routeData.duration == 'none' %}selected{% endif %}>none</option>
                                                            <option value="4 hrs 40 km" {% if routeData.duration == '4 hrs 40 km' %}selected{% endif %}>
                                                                4 hrs 40 km</option>
                                                            <option value="8 hrs 80 km" {% if routeData.duration == '8 hrs 80 km' %}selected{% endif %}>
                                                                8 hrs 80 km</option>
                                                            <option value="12 hrs 120 km" {% if routeData.duration == '12 hrs 120 km' %}selected{% endif %}>12 hrs 120 km</option>
                                                        </select>
                                                    </div>

                                                </div>

                                                <div class="modal-footer justify-end" style="margin: 10px;">
                                                    <div class="flex gap-4">
                                                        <button type="button" class="btn btn-light"
                                                            data-modal-dismiss="true">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" style="background-color: #00b0c3; color: white;">Submit</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div
                            class="card-footer justify-center md:justify-between flex-col md:flex-row gap-3 text-gray-600 text-2sm font-medium">
                            <div class="flex items-center gap-2">
                                Show
                                <select class="select select-sm w-16" data-datatable-size="true" name="perpage">
                                </select>
                                per page
                            </div>
                            <div class="flex items-center gap-4">
                                <span data-datatable-info="true">
                                </span>
                                <div class="pagination" data-datatable-pagination="true">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function filterTable() {
        // Get the value of the input field
        var input = document.getElementById('searcRotute');
        var filter = input.value.toUpperCase();
        var table = document.getElementById('route_table');
        var tr = table.getElementsByTagName('tr');

        // Loop through all table rows
        for (var i = 1; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName('td');
            var rowContainsFilter = false;

            // Loop through all cells in the current row
            for (var j = 0; j < td.length; j++) {
                var cell = td[j];
                if (cell) {
                    var txtValue = cell.textContent || cell.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        rowContainsFilter = true;
                        break; // No need to check further cells if one matches
                    }
                }
            }

            // Display or hide the row based on whether it contains the filter text
            if (rowContainsFilter) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    }
    function userdelete() {
        const checkboxes = document.querySelectorAll('#route_table input[id="checkBOX"]');
        // Filter the checked checkboxes
        const checkedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);

        // Extract values of checked checkboxes
        const checkedValues = checkedCheckboxes.map(checkbox => checkbox.value);

        if (checkedValues != '') {
            console.log('Checked values:', checkedValues);

            $.ajax({
                type: 'GET',
                url: '/user/delete/',
                data: {
                    'user_list': checkedValues,
                },
                success: function (response) {
                    if (response.error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops..',
                            text: 'Something Went Wrong.',
                            showCloseButton: true
                        });
                    } else {
                        Swal.fire({
                            icon: 'success',
                            title: 'Delete Successfull',
                            showConfirmButton: false,
                            timer: 2000
                        });

                        setTimeout(function () {
                            location.reload();
                        }, 2000);
                        $('#UserCreateForm')[0].reset();
                    }
                },
                error: function (error) {
                    console.log(error)
                }
            });
        }

    }
    function DeleteRoutes() {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                // Send the DELETE request to Django
                const checkboxes = document.querySelectorAll('#route_table input[id="checkBOX"]');
                // Filter the checked checkboxes
                const RoutescheckedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);

                // Extract values of checked checkboxes
                const RoutescheckedValues = RoutescheckedCheckboxes.map(checkbox => checkbox.value);

                if (RoutescheckedValues != '') {
                    console.log('Checked values:', RoutescheckedValues);

                    $.ajax({
                        type: 'POST',
                        url: "{% url 'delete-route' %}",
                        data: {
                            'routes_ids': RoutescheckedValues,
                            csrfmiddlewaretoken: '{{ csrf_token }}'  // CSRF token for Django
                        },
                        success: function (response) {
                            if (response.error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops..',
                                    text: 'Something Went Wrong.',
                                    showCloseButton: true
                                });
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Delete Successfull',
                                    showConfirmButton: false,
                                    timer: 2000
                                });

                                setTimeout(function () {
                                    location.reload();
                                }, 2000);
                                $('#UserCreateForm')[0].reset();
                            }
                        },
                        error: function (error) {
                            console.log(error)
                        }
                    });
                }
            }
        });

    }

    function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    function saveInput() {
        let clientId = "123431b9-6234-4e45-8126-8fe82200a8e6";
        let clientSecret = "pZMe7Br1OyH93MyXS6aTVPkuPW1BoexQ";
        let endpoint = "https://account.olamaps.io/realms/olamaps/protocol/openid-connect/token";
        let currentFocus = -1;

        $('.pickup').each(function () {
            let input = $(this);
            let resultsDiv = input.next('.autocomplete-results');

            input.on('input', function () {
                let searchText = input.val();

                if (!searchText) {
                    resultsDiv.hide();
                    return;
                }

                $.ajax({
                    type: 'POST',
                    url: endpoint,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    data: {
                        "grant_type": "client_credentials",
                        "scope": "openid",
                        "client_id": clientId,
                        "client_secret": clientSecret
                    },
                    success: function (response) {
                        let access_token = response.access_token;
                        if (access_token) {
                            $.ajax({
                                type: 'GET',
                                url: `https://api.olamaps.io/places/v1/autocomplete?input=${searchText}`,
                                headers: {
                                    'Authorization': `Bearer ${access_token}`
                                },
                                success: function (data) {
                                    resultsDiv.empty();
                                    currentFocus = -1;

                                    data.predictions.forEach(function (prediction) {
                                        let item = $('<div></div>').text(prediction.description);
                                        item.on('click', function () {
                                            input.val(prediction.description);
                                            resultsDiv.hide();
                                        });
                                        resultsDiv.append(item);
                                    });

                                    let inputOffset = input.offset();
                                    resultsDiv.css({
                                        top: inputOffset.top + input.outerHeight(),
                                        left: inputOffset.left,
                                        width: input.outerWidth()
                                    });

                                    resultsDiv.show();
                                },
                                error: function (error) {
                                    console.error('Error fetching autocomplete results:', error);
                                }
                            });
                        } else {
                            console.error('Failed to retrieve access token');
                        }
                    },
                    error: function (error) {
                        console.error(`Failed to get access token: ${error.status} - ${error.responseText}`);
                    }
                });
            });

            input.on('keydown', function (e) {
                let items = resultsDiv.children('div');

                if (e.keyCode === 40) { // Arrow Down
                    currentFocus++;
                    addActive(items);
                } else if (e.keyCode === 38) { // Arrow Up
                    currentFocus--;
                    addActive(items);
                } else if (e.keyCode === 13) { // Enter
                    e.preventDefault();
                    if (currentFocus > -1) {
                        items.eq(currentFocus).click();
                    }
                }
            });

            function addActive(items) {
                if (!items) return false;
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = items.length - 1;

                let activeItem = items.eq(currentFocus);
                activeItem.addClass('active');

                // Scroll the dropdown if the active item is not fully visible
                let dropdownScrollTop = resultsDiv.scrollTop();
                let dropdownHeight = resultsDiv.outerHeight();
                let itemOffsetTop = activeItem.position().top;
                let itemHeight = activeItem.outerHeight();

                if (itemOffsetTop + itemHeight > dropdownScrollTop + dropdownHeight) {
                    resultsDiv.scrollTop(itemOffsetTop + itemHeight - dropdownHeight);
                } else if (itemOffsetTop < dropdownScrollTop) {
                    resultsDiv.scrollTop(itemOffsetTop);
                }
            }

            function removeActive(items) {
                items.removeClass('active');
            }

            $(document).on('click', function (e) {
                if (!$(e.target).closest(input).length && !$(e.target).closest(resultsDiv).length) {
                    resultsDiv.hide();
                }
            });
        });
    }

    const processChange = debounce(() => saveInput());
    $(document).ready(function () {
    let carData = [];

    // Fetch car type suggestions
    $.ajax({
        url: "{% url 'carType_suggestions' %}",
        method: "GET",
        dataType: "json",
        success: function (data) {
            carData = data;
            
            // Initialize autocomplete for existing inputs
            $('.autoInput').each(function () {
                autocomplete(this, carData);
            });

            // Initialize autocomplete for the new input field 'carModalRoute'
            const carModalRouteInput = document.getElementById('carModalRoute');
            autocomplete(carModalRouteInput, carData);
        },
        error: function (error) {
            console.error('Error fetching car types:', error);
        }
    });

    function autocomplete(inp, arr) {
        var currentFocus;

        $(inp).on("input", function () {
            var val = this.value;
            closeAllLists();
            if (!val) { return false; }
            currentFocus = -1;

            var $a = $("<div>", {
                id: this.id + "-list",
                class: "autocomplete-items"
            });

            $(this).parent().append($a);

            for (var i = 0; i < arr.length; i++) {
                if (arr[i].substr(0, val.length).toUpperCase() === val.toUpperCase()) {
                    var $b = $("<div>").html("<strong>" + arr[i].substr(0, val.length) + "</strong>" + arr[i].substr(val.length));
                    $b.append("<input type='hidden' value='" + arr[i] + "'>");

                    $b.on("click", function () {
                        var fullValue = $(this).find("input").val();

                        if (fullValue) {
                            var parts = fullValue.split(' | ');
                            if (parts.length === 3) {
                                var carModel = parts[0];
                                var carBrand = parts[1];
                                var carType = parts[2];

                                $(inp).val(carModel);
                                $(inp).siblings("input[name='carBrand']").val(carBrand);
                                $(inp).siblings("input[name='carType']").val(carType);
                            } else if (parts.length === 1) {
                                $(inp).siblings("input[name='carType']").val(fullValue);
                                $(inp).val('');
                                $(inp).siblings("input[name='carBrand']").val('');
                            } else {
                                console.error("Unexpected format in fullValue:", fullValue);
                            }
                        } else {
                            console.error("Empty or undefined fullValue");
                        }

                        closeAllLists();
                    });

                    $a.append($b);
                }
            }
        });

        $(inp).on("keydown", function (e) {
            var $x = $("#" + this.id + "-list div");
            if (e.keyCode === 40) { // down
                currentFocus++;
                addActive($x);
            } else if (e.keyCode === 38) { // up
                currentFocus--;
                addActive($x);
            } else if (e.keyCode === 13) { // enter
                e.preventDefault();
                if (currentFocus > -1) {
                    $($x[currentFocus]).click();
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            $(x[currentFocus]).addClass("autocomplete-active");
        }

        function removeActive(x) {
            $(x).removeClass("autocomplete-active");
        }

        function closeAllLists(elmnt) {
            $(".autocomplete-items").each(function () {
                if (elmnt != this && elmnt != inp) {
                    $(this).remove();
                }
            });
        }

        $(document).on("click", function (e) {
            closeAllLists(e.target);
        });
    }

    // Add more rows
    $('#add-more-btn').on('click', function () {
        const carFareContainer = $('#car-fare-container');
        const firstRow = carFareContainer.find('.car-fare-row').first().clone();

        // Clear input values in the cloned row
        firstRow.find('input').val('');

        // Append the cloned row to the container
        carFareContainer.append(firstRow);

        // Initialize autocomplete for the new car model input
        const newCarModelInput = firstRow.find('input[name="carModelId[]"]');
        autocomplete(newCarModelInput[0], carData);

        // Move the "More" button to below the newly added row
        carFareContainer.append($('#more-button-container'));
    });

    // Delete a row
    $(document).on("click", ".delete-row", function () {
        if ($(".car-fare-row").length > 1) {
            $(this).closest(".car-fare-row").remove();
        } else {
            Swal.fire("You must have at least one row.");
        }
    });
});

</script>
{% endblock %}